# Copyright (c) 2016-2017 ForgeRock AS. Use of this source code is subject to the
# Common Development and Distribution License (CDDL) that can be found in the LICENSE file
apiVersion: v1
kind: Pod
metadata:
  name: amster
  labels:
    name: amster
    app: {{ template "fullname" . }}
    vendor: forgerock
    component: amster
spec:
  restartPolicy: Never
  containers:
  - name: amster
    image: {{.Values.image.repository}}/{{ .Values.image.amster}}:{{ .Values.image.tag }}
    imagePullPolicy: {{default "IfNotPresent" .Values.image.pullPolicy}}
    env:
    - name: GIT_REPO
      value: {{ .Values.git.repo }}
    - name: GIT_BRANCH
      value: {{ .Values.git.branch }}
    volumeMounts:
    # The ssh key for Amster authN
    - name: amster-secrets
      mountPath: /var/secrets/amster
      readOnly: true
    # The Amster scripts - not configuration.
    - name: scripts
      mountPath: /opt/amster/scripts
    # configuration files (*.json)
    - name: git
      mountPath: /git
{{- if hasPrefix "ssh:" .Values.git.repo }}
    - name: git-secret
      mountPath: /etc/git-secret
{{- end }}
    args: ["configure"]
    readinessProbe:
      exec:
        command: ["/bin/sh", "-c", "[ -f /var/tmp/CONFIGURED ]" ]
      periodSeconds: 10
      initialDelaySeconds: 30
  volumes:
  - name: amster-secrets
    secret:
      secretName: amster-secrets
  - name: scripts
    configMap:
      name: amster-config
  - name: git
    emptyDir: {}
{{- if hasPrefix "ssh:" .Values.git.repo }}
  - name: git-secret
    secret:
      secretName: git-creds
      defaultMode: 256
{{- end }}