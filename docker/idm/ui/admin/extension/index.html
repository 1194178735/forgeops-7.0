<!--
  Copyright 2015-2017 ForgeRock AS. All Rights Reserved

  Use of this code requires a commercial software license with ForgeRock AS.
  or with one of its affiliates. All use shall be exclusively subject
  to such license between the licensee and ForgeRock AS.
-->
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>OpenIDM</title>

</head>

<body style="display:none">

<div id="messages"></div>
<div id="wrapper"></div>
<div id="popup">
    <div id="popup-content" class="radious"></div>
</div>

<div id="dialog-background"></div>
<div id="dialogs"></div>

<footer id="footer" class="footer"></footer>
<script type="text/javascript">
    var require = {
        urlArgs : "v=${version}",
        deps : ['main']
    };
</script>
<script src="node_modules/oidcsessioncheck/sessionCheckGlobal.js"></script>
<script src="node_modules/appauthhelper/appAuthHelperBundle.js"></script>

<script>
    (function () {
        var AM_URL = window.location.origin + '/am',
            commonSettings = {
                clientId: 'idmAdminClient',
                authorizationEndpoint: AM_URL + '/oauth2/authorize'
            },
            resourceServers = {};

        resourceServers[window.location.origin + "/openidm"] = 'openid fr:idm:.*';

        AppAuthHelper.init({
            clientId: commonSettings.clientId,
            authorizationEndpoint: commonSettings.authorizationEndpoint,
            tokenEndpoint: AM_URL + '/oauth2/access_token',
            revocationEndpoint: AM_URL + '/oauth2/token/revoke',
            endSessionEndpoint: AM_URL + '/oauth2/connect/endSession',
            resourceServers: resourceServers,
            tokensAvailableHandler: function (claims) {
                // this function is called every time the tokens are either
                // originally obtained or renewed
                var sessionCheck = new SessionCheck({
                    clientId: commonSettings.clientId,
                    opUrl: commonSettings.authorizationEndpoint,
                    subject: claims.sub,
                    invalidSessionHandler: function () {
                        AppAuthHelper.logout().then(function () {
                            window.location.href = '/admin/';
                        });
                    },
                    cooldownPeriod: 5
                });
                // check the validity of the session immediately
                sessionCheck.triggerSessionCheck();

                // check with every captured event
                document.addEventListener('click', function () {
                    sessionCheck.triggerSessionCheck();
                });
                document.addEventListener('keypress', function () {
                    sessionCheck.triggerSessionCheck();
                });

                // load the main SPA app
                var mainScript = document.createElement("script");
                mainScript.setAttribute("src", "libs/requirejs-2.1.14-min.js");
                mainScript.setAttribute("data-main", "main");
                mainScript.setAttribute("id", "mainScript");
                document.getElementsByTagName("body")[0].appendChild(mainScript);
            }
        });

        // In this application, we want tokens immediately, before any user interaction is attempted
        AppAuthHelper.getTokens();

        // trigger logout from anywhere in the SPA by calling this global function
        window.logout = function () {
            AppAuthHelper.logout().then(function () {
                window.location.href = '/admin/';
            });
        };
    }());
</script>
</body>
</html>
