# For creating your own custom skaffold profiles we recommend making a copy of this
# file to skaffold-dev.yaml (which is in .gitignore).
# You can "mix and match" diferent services together by creating skaffold profiles
# and by creating a new kustomize profile in kustomize/overlay/
# The default below for skaffold dev is to deploy all services in one shot:
# Note: Upgrade to skaffold/v2alpha3 for skaffold 1.4
apiVersion: skaffold/v2beta10
kind: Config

## Common YAML anchors
## The yaml anchors are used to make it easier to compose skaffold profiles.
## You should not need to edit this section
.YamlAnchors:
  kaniko:
    kaniko-ops: &kaniko-opts
      # Disable build cache for now. This is causing intermittent problems
      # cache: {}
      image: gcr.io/kaniko-project/executor:v1.3.0
      # The flags is deprecated - but without it we are seeing Kaniko bugs.
      # CLOUD-1955
      # flags:
      #   - '--single-snapshot'
      # This is the recommended way of passing the single-snapshot arg - but we see issues.
      # buildArgs:
        # single-snapshot: "true"
    cluster: &kaniko-cluster
      namespace: kaniko
      pullSecretName: kaniko-secret
      pullSecretMountPath: /secrets/kaniko-secret

  artifactDefinitions:
    - &AM
      image: am
      context: docker/7.0/am
    - &AM_KANIKO
      <<: *AM
      kaniko: *kaniko-opts
    - &AMSTER
      image: amster
      context: docker/7.0/amster
    - &AMSTER_KANIKO
      <<: *AMSTER
      kaniko: *kaniko-opts
    - &IDM
      image: idm
      context: docker/7.0/idm
    - &IDM_KANIKO
      <<: *IDM
      kaniko: *kaniko-opts

  commonArtifactSets:
    default-artifacts: &default-artifacts
    - *AM
    - *AMSTER
    - *IDM
    kaniko-artifacts: &kaniko-artifacts
    - *AM_KANIKO
    - *AMSTER_KANIKO
    - *IDM_KANIKO

## End YAML Anchors

#---------------------
# Skaffold profiles
#---------------------

profiles:
# 24/7 Demo environment
- name: nightly
  build: &kaniko-build
    artifacts: *kaniko-artifacts
    cluster: *kaniko-cluster
    tagPolicy:
      sha256: {}
  deploy:
    kustomize:
      paths:
      - kustomize/overlay/7.0/nightly

- name: secrets
  deploy:
    kustomize:
      paths:
      - kustomize/base/secrets

- name: ds
  deploy:
    kustomize:
      paths:
      - kustomize/base/ds-idrepo
      - kustomize/base/ds-cts




