# This is an Amster pod.
# Right now it sits and waits forever. The idea is that you can exec into this
# pod and execute Amster export commands.
# Todo: Do we want a cron job that auto exports every hour? See https://kubernetes.io/docs/user-guide/cron-jobs/
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: amster
  labels:
    name: amster
    app: amster
    helm-name:  {{ template "fullname" . }}
    vendor: forgerock
spec:
  replicas: 1
  template:
    metadata:
      labels:
        helm-name: {{ template "fullname" . }}
        app: amster
        vendor: forgerock
    spec:
       # See https://github.com/kubernetes/git-sync/issues/38
#      securityContext:
#        runAsUser: 0
#      initContainers:
#   include "git-sync" . | indent 6
      containers:
      - name: amster
        image:  {{.Values.image.repository}}/{{ .Values.image.amster}}:{{ .Values.image.tag }}
        imagePullPolicy: {{default "IfNotPresent" .Values.image.pullPolicy}}
        args: ["pause"]
        env:
        - name: GIT_REPO
          value: {{ .Values.git.repo }}
        - name: GIT_BRANCH
          value: {{ .Values.git.branch }}
{{- if hasPrefix "ssh:" .Values.git.repo }}
        - name: GIT_SSH_COMMAND
          value: "ssh -q -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -i /etc/git-secret/ssh"
{{- end }}
        volumeMounts:
        - name: git
          mountPath: /git
        - name: openam-secrets
          mountPath: /var/secrets/amster
          readOnly: true
{{- if hasPrefix "ssh:" .Values.git.repo }}
        - name: git-secret
          mountPath: /etc/git-secret
{{- end }}
      volumes:
      - name: openam-secrets
        secret:
          secretName: openam-secrets
      - name: git
        emptyDir: {}
{{- if hasPrefix "ssh:" .Values.git.repo }}
      - name: git-secret
        secret:
          secretName: git-creds
          defaultMode: 256
{{- end }}