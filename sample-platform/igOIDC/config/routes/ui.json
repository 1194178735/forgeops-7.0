{
    "name": "ui",
    "baseURI": "http://idm-service.sample.svc.cluster.local:8080/",
    "condition": "${matches(request.uri.path, '^/openid/') or matches(request.uri.path, '^/admin') or matches(request.uri.path, '^/user')}",
    "auditService": {
        "type": "AuditService",
        "config": {
            "config": {},
            "event-handlers": [{
                "class": "org.forgerock.audit.handlers.json.JsonAuditEventHandler",
                "config": {
                    "name": "json",
                    "logDirectory": "/tmp/logs",
                    "topics": [
                        "access"
                    ]
                }
            }]
        }
    },
    "heap" : [
        {
            "name": "openidmClient",
            "type": "ClientRegistration",
            "config": {
                "clientId": "openidm",
                "clientSecret": "openidm",
                "issuer": {
                    "type": "Issuer",
                    "config": {
                        "wellKnownEndpoint": "${env['OPENAM_INSTANCE']}/oauth2/.well-known/openid-configuration"
                    }
                },
                "scopes": [
                    "openid"
                ]
            }
        }
    ],
    "handler": {
        "type": "Chain",
        "config": {
            "filters": [
                {
                    "type": "OAuth2ClientFilter",
                    "config": {
                        "clientEndpoint": "/openid",
                        "target": "${session.openid}",
                        "failureHandler": {
                            "type": "StaticResponseHandler",
                            "config": {
                                "status": 401,
                                "headers": {
                                    "Content-Type": [ "application/json" ]
                                },
                                "entity": "{\"code\": 401, \"message\":\"Unable to perform oauth 2 flow\"}"
                            }
                        },
                        "registrations": [
                            "openidmClient"
                        ],
                        "requireHttps": false
                    }
                },
                {
                    "name": "switch",
                    "type": "SwitchFilter",
                    "config": {
                        "onResponse": [
                            {
                                "condition": "${response.status.code == 401}",
                                "handler": {
                                    "type": "StaticResponseHandler",
                                    "config": {
                                        "status": 302,
                                        "headers": {
                                            "Location": [ "/logout"]
                                        }
                                    }
                                }
                            }
                        ]
                    }
                },
                {
                    "type": "ScriptableFilter",
                    "config": {
                        "type": "application/x-groovy",
                        "file": "getAccessTokenFromSession.groovy"
                    }
                },
                {
                    "type": "OAuth2ResourceServerFilter",
                    "config": {
                        "scopes": [
                            "openid"
                        ],
                        "requireHttps": false,
                        "accessTokenResolver": {
                            "type": "TokenIntrospectionAccessTokenResolver",
                            "config": {
                                "endpoint": "${env['OPENAM_INSTANCE']}/oauth2/introspect",
                                "providerHandler": {
                                    "type": "Chain",
                                    "config": {
                                        "filters": [
                                            {
                                                "type": "HeaderFilter",
                                                "config": {
                                                    "messageType": "request",
                                                    "add": {
                                                        "Authorization": [
                                                            "Basic ${encodeBase64('openidm:openidm')}"
                                                        ]
                                                    }
                                                }
                                            }
                                        ],
                                        "handler": "ForgeRockClientHandler"
                                    }
                                }
                            }
                        },
                        "cacheExpiration": "2 minutes"
                    }
                }
            ],
            "handler": "ForgeRockClientHandler"
        }
    }
}
