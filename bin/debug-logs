#!/usr/bin/env python3
# This script gets all logs, descriptions, events from a selected namespace.
# It replaces debug-logs.sh.

import argparse
from datetime import datetime
from pathlib import Path
import subprocess
import sys

import utils

def _get_container_logs(namespace, pod, containers, maxloglines):
    container_logs = []
    for container in containers:
        container_log = ''
        get_output, _ = utils.run('kubectl', f'--namespace {namespace} logs {pod} -c {container}', cstdout=True)
        # Split the output into lines...
        get_output = get_output.decode('utf-8').splitlines()
        # ... and join the lines into a string, adding <br> at the end of each line
        container_log ='<br>'.join(get_output[0:maxloglines])
        container_logs.append(container_log)
    return container_logs

def _get_containers(namespace, pod):
    containers = []

    # Get app containers
    get_pods_output, _ = utils.run('kubectl', f'get pods {pod} '
        f'--namespace {namespace} --output=jsonpath={{.spec.containers[*].name}}',cstdout=True)
    containers.append(get_pods_output.decode('utf-8').split())

    # Get init containers
    get_pods_output, _ = utils.run('kubectl', f'get pods {pod} '
        f'--namespace {namespace} --output=jsonpath={{.spec.initContainers[*].name}}',cstdout=True)
    containers.append(get_pods_output.decode('utf-8').split())

    # Return a list with two elements: a list of non-init containers, and a list of containers
    return containers

def get_pods(namespace):
    get_pods_output, _ = utils.run('kubectl', f'get pods '
        f'--namespace {namespace} --output=jsonpath={{.items..metadata.name}}',cstdout=True)
    return get_pods_output.decode('utf-8').split()

def get_pvcs(namespace):
    get_pvc_output, _ = utils.run('kubectl', f'get pvc '
        f'--namespace {namespace} --output=jsonpath={{.items..metadata.name}}',cstdout=True)
    return get_pvc_output.decode('utf-8').split()

def write_context(output):
    get_output = utils.get_context()

    # Write section
    context_html = '''
    <br>
    <h2><a id="context">Kubernetes Context</a></h2>
    <pre>{get_output}</pre>
    <p><a href="#toc">Back to Index</a></p>
    <br>
    '''.format(get_output=get_output)
    output.write(context_html)

def write_crds(output):
    get_output, _ = utils.run('kubectl', 'get crds',cstdout=True)
    get_output = get_output.decode('utf-8').replace('\n', '<br/>')

    # Write section
    crds_html = '''
    <br>
    <h2><a id="crds">CRDs</a></h2>
    <pre>{get_output}</pre>
    <p><a href="#toc">Back to Index</a></p>
    <br>
    '''.format(get_output=get_output)
    output.write(crds_html)

def write_git_log(output):
    get_output, _ = utils.run('git', f'--no-pager log -n 10',cstdout=True)
    get_output = get_output.decode('utf-8').replace('\n', '<br/>')

    # Write section
    git_log_html = '''
    <br>
    <h2><a id="git">Forgeops Repository Git Log (Most Recent Entries)</a></h2>
    <pre>{get_output}</pre>
    <p><a href="#toc">Back to Index</a></p>
    <br>
    '''.format(get_output=get_output)
    output.write(git_log_html)

def write_header(output, namespace):
    # Get current date and time
    now = datetime.now()

    # Write file heading
    heading_html = '''
    <html>
    <h1>Debug output for namespace {namespace} logged at {now}</h1>
    <br>
    '''.format(namespace=namespace,now=now)
    output.write(heading_html)

def write_objects(output, namespace, obj):
    # Get kubectl CLI output for the objects
    get_cli_output, _ = utils.run('kubectl', f'--namespace {namespace} get {obj[0]}',cstdout=True)
    get_cli_output = get_cli_output.decode('utf-8').replace('\n', '<br/>')
    # Get object YAML
    get_yaml_output, _ = utils.run('kubectl', f'--namespace {namespace} get {obj[0]} --output yaml',cstdout=True)
    get_yaml_output = get_yaml_output.decode('utf-8').replace('\n', '<br/>')

    # Write section
    obj_html = '''
    <br>
    <h2><a id="{obj[1]}">{obj[1]}</a></h2>
    <pre>{get_cli_output}</pre>
    <p><a href="#toc">Back to Index</a></p>
    <br>
    <h2><a id="{obj[2]}">{obj[2]}</a></h2>
    <pre>{get_yaml_output}</pre>
    <p><a href="#toc">Back to Index</a></p>
    '''.format(obj=obj,get_cli_output=get_cli_output,get_yaml_output=get_yaml_output)
    output.write(obj_html)

def write_operator_logs(output, operator, maxloglines):
    # Get operator pod name
    try:
        get_pods_output, _ = utils.run('kubectl', f'get pods '
            f'-l {operator[0]} -n {operator[1]} --field-selector=status.phase==Running '
            f'--output=jsonpath={{.items..metadata.name}}',cstdout=True)
        pod = get_pods_output.decode('utf-8').split()[0]

        # Get log
        get_log_output, _ = utils.run('kubectl', f'--namespace {operator[1]} logs {pod} -c {operator[2]}', cstdout=True)
    except subprocess.CalledProcessError as e:
        print(f'Error getting pods or pod logs: {e.cmd} {e.output}')
        sys.exit(1)
    except IndexError as e:
        print(f'Didn\'t find {operator[3]} operator pod')
        sys.exit(1)
    except Exception as e:
        print(f'Unexpected error {e}')
        sys.exit(1)

    # Split the output into lines...
    get_log_output = get_log_output.decode('utf-8').splitlines()
    # ... and join the lines into a string, adding <br> at the end of each line
    log ='<br>'.join(get_log_output[0:maxloglines])

    # Write it out
    operator_log_html = ''' 
    <h2><a id="{operator_name}">{operator_name} Container Log:</a></h3>
    <pre>{log}</pre>
    <p><a href="#toc">Back to Index</a></p>
    '''.format(pod=pod,container=operator[2],log=log,operator_name=operator[3])
    output.write(operator_log_html)

def write_pod_description_and_container_logs(output, namespace, pod, maxloglines):
    # Get pod description
    get_output, _ = utils.run('kubectl', f'--namespace {namespace} describe pod {pod}',cstdout=True)
    get_output = get_output.decode('utf-8').replace('\n', '<br/>')

    # Get logs for this pod's app and init containers
    pod_containers = _get_containers(namespace, pod)
    app_container_logs = _get_container_logs(namespace, pod, pod_containers[0], maxloglines)
    init_container_logs = _get_container_logs(namespace, pod, pod_containers[1], maxloglines)

    # Write pod description
    poddesc_html = '''
    <hr>
    <h2><a id="{pod}">{pod}</a></h2>
    <h3>Pod Description:</a></h3>
    <pre>{get_output}</pre>
    <p><a href="#toc">Back to Index</a></p>
    '''.format(pod=pod,get_output=get_output)
    output.write(poddesc_html)

    # Write the log for each app container
    for i, container in enumerate(pod_containers[0]):
        log = app_container_logs[i]
        app_container_log_html = '''
        <h3>Logs for Container {container}:</h3>
        <pre>{log}</pre>
        <p><a href="#toc">Back to Index</a></p>
        '''.format(container=container,log=log)
        output.write(app_container_log_html)

    # Write the log for each init container
    for i, container in enumerate(pod_containers[1]):
        log = init_container_logs[i]
        init_container_log_html = '''
        <h3>Logs for Init Container {container}:</h3>
        <pre>{log}</pre>
        <p><a href="#toc">Back to Index</a></p>
        '''.format(container=container,log=log)
        output.write(init_container_log_html)

def write_pvc_description(output, namespace, pvc):
    # Get PVC description
    get_output, _ = utils.run('kubectl', f'--namespace {namespace} describe pvc {pvc}',cstdout=True)
    get_output = get_output.decode('utf-8').replace('\n', '<br/>')

    # Write PVC description
    pvcdesc_html = '''
    <hr>
    <h2><a id="{pvc}">{pvc}</a></h2>
    <h3>PVC Description:</a></h3>
    <pre>{get_output}</pre>
    <p><a href="#toc">Back to Index</a></p>
    '''.format(pvc=pvc,get_output=get_output)
    output.write(pvcdesc_html)

def write_storage_classes(output, namespace):
    get_output, _ = utils.run('kubectl', f'--namespace {namespace}, get storageclasses',cstdout=True)
    get_output = get_output.decode('utf-8').replace('\n', '<br/>')

    # Write section
    storageclasses_html = '''
    <br>
    <h2><a id="storageclasses">Kubernetes Storage Classes</a></h2>
    <pre>{get_output}</pre>
    <p><a href="#toc">Back to Index</a></p>
    <br>
    '''.format(get_output=get_output)
    output.write(storageclasses_html)

def write_sw_versions(output):
    # Get third-party software versions
    kubectl, _ = utils.run('kubectl', 'version --client=true --short', cstdout=True, cstderr=True)
    kubectl = kubectl.decode('ascii').split(' ')[-1].strip()
    kustomize, _ = utils.run('kustomize', 'version --short', cstdout=True, cstderr=True)
    kustomize = kustomize.decode('ascii').split()[0].split('/')[-1]
    skaffold, _ = utils.run('skaffold', 'version', cstdout=True, cstderr=True)
    skaffold = skaffold.decode('ascii').strip()

    # Write PVC description
    sw_versions_html = '''
    <hr>
    <h2><a id="sw_versions">Third-Party Software Versions:</a></h2>
    <p>
    kubectl: {kubectl}</br>
    kustomize: {kustomize}</br>
    skaffold: {skaffold}</br>
    <p><a href="#toc">Back to Index</a></p>
    '''.format(kubectl=kubectl, kustomize=kustomize, skaffold=skaffold)
    output.write(sw_versions_html)

def write_toc(output, pods, pvcs, objs, operators):
    # Build TOCs of pods, PVCs, and other objects
    pods_toc = ''
    for pod in pods:
        pods_toc += f'<li><a href="#{pod}">{pod}</a></li>'
    pvcs_toc = ''
    for pvc in pvcs:
        pvcs_toc += f'<li><a href="#{pvc}">{pvc}</a></li>'
    operators_toc = ''
    for operator in operators:
        operators_toc += f'<li><a href="#{operator[3]}">{operator[3]}</a></li>'
    objects_toc = ''
    for obj in objs:
        objects_toc += f'<li><a href="#{obj[1]}">{obj[1]}</a></li>'
        objects_toc += f'<li><a href="#{obj[2]}">{obj[2]}</a></li>'
    other_toc = ''
    other_toc += f'<li><a href="#context">Kubernetes context</a></li>'
    other_toc += f'<li><a href="#sw_versions">Third-Party Software Versions</a></li>'
    other_toc += f'<li><a href="#crds">CRDs</a></li>'
    other_toc += f'<li><a href="#storageclasses">Kubernetes storage classes</a></li>'
    other_toc += f'<li><a href="#git">forgeops repository Git log (most recent entries)</a></li>'

    # Write TOC
    toc_html = '''
    <h2><a id="toc">Pod Descriptions and Container Logs</a></h2>
    <ul>
    {pods_toc}
    </ul>
    <h2>PVC Descriptions</h2>
    <ul>
    {pvcs_toc}
    </ul>
    <h2>Operator Logs</h2>
    <ul>
    {operators_toc}
    </ul>
    <h2>Kubernetes Objects</h2>
    <ul>
    {objects_toc}
    </ul>
    <h2><a id="toc">Other Diagnostic Information</a></h2>
    <ul>
    {other_toc}
    </ul>
    '''.format(pods_toc=pods_toc,pvcs_toc=pvcs_toc,objects_toc=objects_toc,operators_toc=operators_toc,other_toc=other_toc)
    output.write(toc_html)

def main():
    # Parse input arguments
    parser = argparse.ArgumentParser(description='Aggregate pod logs and descriptions')
    parser.add_argument('-m', '--max-log-lines', dest='maxloglines',
                        help='Maximum lines to print from each container log (default: 400)')
    parser.add_argument('-n', '--namespace',
                        help='Target namespace (default: current namespace)')
    args = parser.parse_args()
    maxloglines = args.maxloglines if getattr(args, 'maxloglines', None) else 4002

    # Get the namespace (either passed in as an arg, or set in the user's context)
    ctx_namespace = utils.get_namespace()
    namespace = getattr(args, 'namespace', None) or ctx_namespace

    # Definitions of some stuff we'll be getting information about
    operators = [['app.kubernetes.io/name=secret-agent-manager', 'secret-agent-system', 'manager', 'secret-agent'],
                 ['control-plane=ds-operator', 'fr-system', 'ds-operator', 'ds-operator']]
    objs = [['service', 'Services (kubectl CLI output)', 'Services (YAML)'],
            ['ingress', 'Ingress (kubectl CLI output)', 'Ingress (YAML)'],
            ['configmap', 'Configmap (kubectl CLI output)', 'Configmap (YAML)'],
            ['secrets', 'Secrets (kubectl CLI output)', 'Secrets (YAML)']]

    # Get pod names and PVCs in lists
    pods = get_pods(namespace)
    pvcs = get_pvcs(namespace)

    # Open the output file. Overwrite any previous content in it.
    Path('/tmp/forgeops').mkdir(parents=True, exist_ok=True)
    output_file = '/tmp/forgeops/log.html'
    with open(output_file, 'w') as output:

        # Write the header and TOC
        write_header(output, namespace)
        write_toc(output, pods, pvcs, objs, operators)

        # Write pod descriptions and container logs
        for pod in pods:
            write_pod_description_and_container_logs(output, namespace, pod, int(maxloglines))

        # Write operator logs
        for operator in operators:
            write_operator_logs(output, operator, int(maxloglines))

        # Write PVC descriptions
        for pvc in pvcs:
            write_pvc_description(output, namespace, pvc)

        # Write special objects (CLI and YAML output)
        for obj in objs:
            write_objects(output, namespace, obj)

        # Write some other miscellaneous diagnostics
        write_context(output)
        write_sw_versions(output)
        write_crds(output)
        write_storage_classes(output, namespace)
        write_git_log(output)

    # Print message to user
    print(f'Open {output_file} in your browser.')

if __name__ == "__main__":
    main()
