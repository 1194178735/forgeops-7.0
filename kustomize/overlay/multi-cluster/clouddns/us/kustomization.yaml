# Deploys multi-cluster DS: ds-cts and ds-idrepo
# The namespace must be identical for all regions
namespace: prod
resources:
- ../../../../base/kustomizeConfig
- ../../multi-cluster-secrets
- ../../../../base/ds/idrepo
- ../../../../base/ds/cts 
- ../../../../base/ldif-importer

patchesStrategicMerge:
  - |-
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: platform-config
    data:
      FQDN: prod.mci.forgeops.com
      AM_STORES_CTS_SERVERS: "ds-cts-0.ds-cts:1636,ds-cts-1.ds-cts:1636"
      AM_STORES_USER_SERVERS: "ds-idrepo-0.ds-idrepo:1636,ds-idrepo-1.ds-idrepo:1636"
  - |-
    #Patch DS CTS
    apiVersion: apps/v1
    kind: StatefulSet
    metadata:
      name: ds-cts
    spec:
      replicas: 2
      template:
        spec:
          containers:
            - name: ds
              imagePullPolicy: Always
              resources:
                requests:
                  memory: 4Gi
                  cpu: 2
                limits:
                  memory: 4Gi
                  cpu: 2
              env: 
              - name: DS_CLUSTER_TOPOLOGY
                value: "eu,us"
              - name: DS_BOOTSTRAP_REPLICATION_SERVERS
                value: "ds-cts-0.ds-cts.prod.svc.us:8989,ds-cts-0.ds-cts.prod.svc.eu:8989"
          initContainers:
            - name: initialize
              imagePullPolicy: Always
      volumeClaimTemplates:
      - metadata:
          name: data
          annotations:
            pv.beta.kubernetes.io/gid: "0"
        spec:
          accessModes: [ "ReadWriteOnce" ]
          resources:
            requests:
              storage: 250Gi
              
  - |-
    #Patch DS IDREPO
    apiVersion: apps/v1
    kind: StatefulSet
    metadata:
      name: ds-idrepo
    spec:
      replicas: 2
      template:
        spec:
          containers:
            - name: ds
              imagePullPolicy: Always
              resources:
                requests:
                  memory: 4Gi
                  cpu: 2
                limits:
                  memory: 4Gi
                  cpu: 2
              env: 
              - name: DS_CLUSTER_TOPOLOGY
                value: "eu,us"
              - name: DS_BOOTSTRAP_REPLICATION_SERVERS
                value: "ds-idrepo-0.ds-idrepo.prod.svc.us:8989,ds-idrepo-0.ds-idrepo.prod.svc.eu:8989"
          initContainers:
            - name: initialize
              imagePullPolicy: Always
      volumeClaimTemplates:
      - metadata:
          name: data
          annotations:
            pv.beta.kubernetes.io/gid: "0"
        spec:
          accessModes: [ "ReadWriteOnce" ]
          resources:
            requests:
              storage: 10Gi